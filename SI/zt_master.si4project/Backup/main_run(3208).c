#include "config.h"
#include "init.h"
#include "version.h"
#include "event.h"
#include "ssz_common.h"
#include "com.h"
#include "timer.h"
#include "cpu_usage.h"
#include "sys_power.h"
#include "app_mcu_comm.h"
#include "mid_common.h"

#include "GUI.h"
#include "WM.h"

#include "ert_RTC.h"
#include "ert_channelsADC_Major.h"
#include "ert_getKeyVector.h"

/************************************************
* Declaration
************************************************/
extern void do_before_main_loop();
extern void run_test_after_main();

/************************************************
* Variable 
************************************************/
static GUI_CONST_STORAGE GUI_COLOR _Colorsbolus_set[] = {
#if (GUI_USE_ARGB == 0)
  0x000000, 0xFFFFFF
#else
  0xFF000000, 0xFFFFFFFF
#endif

};

static GUI_CONST_STORAGE GUI_LOGPALETTE _Palbolus_set = {
  2,  // Number of entries
  0,  // No transparency
  &_Colorsbolus_set[0]
};

static GUI_CONST_STORAGE unsigned char _acbolus_set[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

GUI_CONST_STORAGE GUI_BITMAP bmbolus_set = {
  38, // xSize
  33, // ySize
  19, // BytesPerLine
  4, // BitsPerPixel
  _acbolus_set,  // Pointer to picture data (indices)
  &_Palbolus_set   // Pointer to palette
};


GUI_CONST_STORAGE unsigned char acGUI_Fontdengxian16_6CF5[ 32] = { /* code 6CF5 */
  ________,________,
  __XXXXXX,XXXXXX__,
  _____X__,________,
  ____XXXX,XXXX____,
  ___XX___,___X____,
  __XXX___,___X____,
  _X__XXXX,XXXX____,
  _______X,____X___,
  __XXXXXX,X__X____,
  _____X_X,XXX_____,
  ____XX_X,_XX_____,
  ___XX__X,__XX____,
  __X____X,____XX__,
  ______XX,________,
  ________,________,
  ________,________};

GUI_CONST_STORAGE unsigned char acGUI_Fontdengxian16_75DB[ 32] = { /* code 75DB */
  ________,________,
  _______X,X_______,
  ___XXXXX,XXXXXX__,
  ___X____,________,
  _X_X_XXX,XXXXX___,
  __XX___X,___X____,
  ___X____,XXX_____,
  ___X_XXX,XXXXX___,
  _XXX_X__,_X__X___,
  ___X_XXX,XXXXX___,
  ___X_X__,_X__X___,
  __XX_XXX,XXXXX___,
  __X__X__,_X__X___,
  _X___X__,___XX___,
  ________,________,
  ________,________};

GUI_CONST_STORAGE unsigned char acGUI_Fontdengxian16_9547[ 32] = { /* code 9547 */
  ___X____,_X______,
  ___X__XX,XXXXXX__,
  __XXXX__,_X______,
  _XX____X,XXXXX___,
  XX_____X,____X___,
  __XXXX_X,XXXXX___,
  ___X___X,____X___,
  ___X___X,XXXXX___,
  _XXXXX_X,____X___,
  ___X___X,XXXXX___,
  ___X___X,____X___,
  ___X_XXX,XXXXXXX_,
  ___XX___,XX__X___,
  ___X_XXX,_____X__,
  ________,________,
  ________,________};

GUI_CONST_STORAGE GUI_CHARINFO GUI_Fontdengxian16_CharInfo[3] = {
   {  15,  15,  2, acGUI_Fontdengxian16_6CF5 } /* code 6CF5 */
  ,{  15,  15,  2, acGUI_Fontdengxian16_75DB } /* code 75DB */
  ,{  15,  15,  2, acGUI_Fontdengxian16_9547 } /* code 9547 */
};

GUI_CONST_STORAGE GUI_FONT_PROP GUI_Fontdengxian16_Prop3 = {
   0x9547 /* first character */
  ,0x9547 /* last character  */
  ,&GUI_Fontdengxian16_CharInfo[  2] /* address of first character */
  ,(GUI_CONST_STORAGE GUI_FONT_PROP *)0 /* pointer to next GUI_FONT_PROP */
};

GUI_CONST_STORAGE GUI_FONT_PROP GUI_Fontdengxian16_Prop2 = {
   0x75DB /* first character */
  ,0x75DB /* last character  */
  ,&GUI_Fontdengxian16_CharInfo[  1] /* address of first character */
  ,&GUI_Fontdengxian16_Prop3 /* pointer to next GUI_FONT_PROP */
};

GUI_CONST_STORAGE GUI_FONT_PROP GUI_Fontdengxian16_Prop1 = {
   0x6CF5 /* first character */
  ,0x6CF5 /* last character  */
  ,&GUI_Fontdengxian16_CharInfo[  0] /* address of first character */
  ,&GUI_Fontdengxian16_Prop2 /* pointer to next GUI_FONT_PROP */
};

GUI_CONST_STORAGE GUI_FONT GUI_Fontdengxian16 = {
   GUI_FONTTYPE_PROP /* type of font    */
  ,16 /* height of font  */
  ,16 /* space of font y */
  ,1 /* magnification x */
  ,1 /* magnification y */
  ,{&GUI_Fontdengxian16_Prop1}
  ,13 /* Baseline */
  ,8 /* Height of lowercase characters */
  ,11 /* Height of capital characters */
};




/************************************************
* Function 
************************************************/
static void main_handle_pc_uart_recv()
{
	com_handle_new_received_data(kComPCUart);
}
static void main_handle_bt_uart_recv()
{
	com_handle_new_received_data(kComBTUart);
}
static void main_handle_mcu_uart_recv()
{
	com_handle_new_received_data(kComMCUUart);
}


static void main_init_event_handler() {
	event_set_handler(kEventNewTick, timer_handle_all);
	event_set_handler(kEventPCUartReceiveNewData, main_handle_pc_uart_recv);
    event_set_handler(kEventBTUartReceiveNewData, main_handle_bt_uart_recv);
    event_set_handler(kEventMCUUartReceiveNewData, main_handle_mcu_uart_recv);
}

/***********************************************
* Description:
*   handle all(e.g. event, timer, data receive...)
* Argument:
*
* Return:
*   if not handle anything, return false, otherwise return true
************************************************/
bool main_handle_all(void)
{
	bool ret = false;

	
	for (int i = 0; i < kEventIDMax; i++)
	{
		if (event_is_set((EventID)i))
		{
			event_clear((EventID)i);
			event_handle((EventID)i);
			ret = true;
		}
	}

	return ret;
}

#ifdef TEST
void run_unit_test(){
	extern int run_test_main(int argc, const char **argv);
	
	sys_power_enable();
	app_mcu_send_to_slave(COMM_POWER_ON,0,0);
	
	char *args[] = {
		"-t","data_write",	//-t casename, run the case who's name have the substr
		"-s","",  //-s suitename, run the suite who's name have the substr
		//"-a",  //-a - when test fail, assert to let user debug
		//"-v",  //-v - Verbose output
		//"-l",  //-l - List suites and their tests, then exit
	};
	run_test_main(ssz_array_size(args), (const char **)args);
	msg_clear_all_handler();
	//wait cmd
	while (1)
	{
		//handle all
		if (main_handle_all() == false)
		{
			//if nothing need handle, go to sleep
			ssz_sleep();
		}
		//clear watchdog
	}
	return;

}
#endif

/*
void wm_bk_callback(WM_MESSAGE *pMsg)
{
	switch(pMsg->MsgId)
	{
		case WM_PAINT:
			WINDOW_SetBkColor(pMsg->hWin, GUI_WHITE);
            //GUI_Clear();
			break;

		default:
			WM_DefaultProc(pMsg);
			break;

	}
}
*/

static TimeStamp ts;
static int pwradc;
static uint8_t key[5];

void test(void)
{
	//uint8_t data = 0xFF;
	//ERT_rtc_get(&ts);
	//ert_channelsADC(1, 
	//				&pwradc,
	//				NULL,
	//				NULL,
	//				NULL,
	//				NULL);
	//ert_getKeyVector(key);
	//GUI_SetColor(GUI_WHITE);
	//GUI_DispString("12345");
	//WM_SetBkWindowColor(GUI_W);
	//GUI_SetFont(&GUI_Font10_ASCII);
	//GUI_DispStringAt("str", 5, 10);
    //GUI_DrawRect(7, 9, 70, 35);

	//for(int i=5; i< 40; i++)
	//display_data_at(10, i, (uint8_t *)&data , 1);
		//GUI_SetColor(GUI_WHITE);
		//GUI_DispStringAt("str",4, 5);

		//pwradc = GUI_GetBkColor();
		//ui_draw_pixel_at(6, 8);
		
		//ui_draw_hline_at(6, 9, 16);
	
}

/***********************************************
* Description:
*   main 
*
* Argument:
*
* Return:
*
************************************************/
void main_run(void)
{
    //init all modules
	init_all();
	//init event handler
	main_init_event_handler();

	ssz_traceln("%s power on.", version_software_name());
#ifdef TEST
	run_unit_test();
#endif

	//do after init, before enter main loop
	do_before_main_loop();

	//run test something at once
	run_test_after_main();

#if CPU_USAGE_MODULE_ENABLE
	cpu_usage_reset_usage();
#endif


	GUI_Init();
	//GUI_UC_SetEncodeUTF8();
	GUI_SetBkColor(GUI_BLACK);
	//WM_SetCallback(WM_HBKWIN, wm_bk_callback);
	GUI_SetColor(GUI_WHITE);
	
	//GUI_DispString("12345");
	//GUI_SetTextMode(GUI_TEXTMODE_REV);
	GUI_SetFont(&GUI_Font20B_ASCII);
    GUI_DispString("12345");
	
   GUI_DrawRect(60, 8, 70, 35);
   GUI_FillCircle(100, 32, 20);
   GUI_DrawBitmap(&bmbolus_set, 180, 8);
   //pwradc =GUI_GetBkColorIndex();
	//pwradc =GUI_GetColorIndex();
   
 	GUI_SetFont(&GUI_Fontdengxian16);
    
	GUI_DispStringAt("\xe9\x95\x87\xe7\x97\x9b\xe6\xb3\xb5", 180, 45);

	timer_set_handler(kTimerTest, test);
	timer_start_periodic_every(kTimerTest, 1000);


    while(1)
    {
		//handle all
		if (main_handle_all() == false)
		{
			//if nothing need handle, go to sleep
#if CPU_USAGE_MODULE_ENABLE
			cpu_usage_enter_idle();
#endif
			//ssz_sleep();
#if CPU_USAGE_MODULE_ENABLE
			cpu_usage_exit_idle();
			//cpu_usage_print_if_large_than(20);
#endif
		}
		//GUI_Delay(1);
		GUI_Exec();
        //clear watchdog
		//ssz_clear_watchdog();
		
    }
}
